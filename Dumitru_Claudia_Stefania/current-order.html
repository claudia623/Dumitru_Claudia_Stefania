<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Comanda curentă</title>
  <link rel="stylesheet" href="style.css">
</head>
<body class="site-layout">
  <header>
    <h1>Magazin de Plușuri Croșetate</h1>
  </header>
  <nav>
    <div class="nav-center">
      <a href="index.html">Acasă</a>
      <a href="produse.html">Produse</a>
      <a href="contact.html">Contact</a>
    </div>
    <div class="nav-right">
      <a href="cart.html" class="cart-icon" title="Coș de cumpărături">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M7 20a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm10 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM7.16 16h9.68c.8 0 1.5-.48 1.8-1.22l3.24-7.24A1 1 0 0 0 21 6H6.21l-.94-2.36A1 1 0 0 0 4.34 2H1v2h2.34l3.6 9.03-1.35 2.44C4.52 16.37 5.48 18 7 18h12v-2H7.42a.25.25 0 0 1-.22-.13l.96-1.87z"/></svg>
        <span class="cart-badge" id="cart-badge" style="display:none">0</span>
      </a>
      <a href="login.html" class="login-link">Login</a>
    </div>
  </nav>

  <main class="container">
    <h2>Comanda curentă</h2>
    <div id="order-root" style="margin-top:16px"></div>
  </main>

  <aside>
      <div class="newsletter-box" style="padding:15px; background:rgba(212,99,122,0.05); border-radius:10px; margin-top:20px;">
          <h4 style="margin-top:0">Newsletter</h4>
          <p style="font-size:0.9rem">Abonează-te pentru a afla când adaug plușuri noi!</p>
          <input type="email" placeholder="email@exemplu.com" style="margin-bottom:8px">
          <button class="add-btn" style="width:100%">Abonează-te</button>
      </div>
  </aside>

  <footer class="site-footer">
    <div class="container">
      <div class="footer-grid">
        <div class="footer-about"><h4>Despre noi</h4><p>Plușuri croșetate manual.</p></div>
        <div class="footer-contact"><h4>Contact</h4><p>Email: <a href="mailto:plusuricrosetate@email.com">plusuricrosetate@email.com</a></p></div>
        <div class="footer-links"><h4>Link-uri</h4><p><a href="produse.html">Produse</a></p></div>
      </div>
    </div>
  </footer>

  <script src="auth-api.js"></script>
  <script src="products-api.js"></script>
  <script src="cart.js"></script>
  <script src="site-ui.js"></script>
  <script src="favorites.js"></script>
  <script>
    (function(){
      // Calculează totalul general al coșului pentru afișare în formular
      function total(cart){ return (cart||[]).reduce(function(s,i){ return s + Number((i.price||i.pret_unitar||0)) * Number((i.qty||i.cantitate||1)); }, 0); }
      
      // Funcție pentru afișarea de notificări (toast)
      function toast(m){ try{ window.dispatchEvent(new CustomEvent('siteToast',{detail:{message:m, position:'center'}})); }catch(e){} }

      document.addEventListener('DOMContentLoaded', function(){
        // Verificăm dacă utilizatorul este logat. Cerința obligatorie pentru a plasa comanda.
        var u = window.auth && window.auth.getCurrentUser && window.auth.getCurrentUser();
        if(!u){ window.location.href = 'login.html'; return; }
        
        var root = document.getElementById('order-root');
        if(!window.cartAPI || !window.cartAPI.getCart){ root.innerHTML = '<p>Nu poți plasa comanda în acest moment.</p>'; return; }
        
        // Preluăm produsele din coș pentru a le recapitula înainte de plasare
        window.cartAPI.getCart().then(function(cart){
          cart = cart || [];
          if(!cart.length){ root.innerHTML = '<div class="login-section"><p>Nu ai produse în comanda curentă.</p></div>'; return; }

          var sum = total(cart);
          var html = '<div class="cart-card" style="max-width: 600px; margin: 0 auto;">';
          html += '<h3>Produse în comandă</h3>';
          html += '<table class="cart-list"><thead><tr><th>Produs</th><th>Cantitate</th><th>Total</th></tr></thead><tbody>';
          cart.forEach(function(it){ 
             var price = Number(it.price||it.pret_unitar||0), qty = Number(it.qty||it.cantitate||1), line = price * qty; 
             html += '<tr><td>'+ (it.title||it.nume_produs||'') +'</td><td>'+ qty +'</td><td>'+ line +' lei</td></tr>'; 
          });
          html += '</tbody></table>';
          html += '<div style="margin-top:10px;text-align:right;font-weight:800;font-size:1.2rem;color:var(--accent);">Total de plată: '+ sum +' lei</div>';
          
          html += '<hr style="margin: 20px 0; border: 0; border-top: 1px solid rgba(0,0,0,0.06);">';
          
          // FORMULAR DE LIVRARE (Cerința 6 - Date introduse de utilizator)
          html += '<h3>Detalii Livrare</h3>';
          html += '<form id="checkout-form" style="display:flex; flex-direction:column; gap:12px; margin-top:15px;">' +
                  '<div class="field"><label>Nume complet</label><input type="text" id="order-nume" required></div>' +
                  '<div class="field"><label>Telefon</label><input type="tel" id="order-tel" required></div>' +
                  '<div class="field"><label>Adresă livrare</label><textarea id="order-adresa" rows="2" required></textarea></div>' +
                  '<div class="form-grid-2">' +
                    '<div class="field"><label>Oraș</label><input type="text" id="order-oras" required></div>' +
                    '<div class="field"><label>Cod poștal</label><input type="text" id="order-postal" required></div>' +
                  '</div>' +
                  '<div class="field"><label>Metodă plată</label><select id="order-plata"><option value="plata_la_livrare">Plată la livrare (Ramburs)</option><option value="card_online">Card Online</option></select></div>' +
                  '<div style="margin-top:14px;text-align:right">' +
                    '<a class="btn ghost" href="cart.html" style="margin-right:8px;padding:10px 12px;border:1px solid rgba(0,0,0,0.06);border-radius:8px;text-decoration:none;color:var(--accent);font-weight:800">Înapoi la coș</a>' +
                    '<button type="submit" id="place-order" class="add-btn" style="min-width:180px">Plasează Comanda</button>' +
                  '</div>' +
                  '</form>';
          html += '</div>';
          root.innerHTML = html;

          // PRE-COMPLETARE DATE din profilul salvat local (UX îmbunătățit)
          var profile = JSON.parse(localStorage.getItem('profile_' + u.id_utilizator) || '{}');
          if(profile.full_name) document.getElementById('order-nume').value = profile.full_name;
          if(profile.phone) document.getElementById('order-tel').value = profile.phone;
          if(profile.address) document.getElementById('order-adresa').value = profile.address;
          if(profile.city) document.getElementById('order-oras').value = profile.city;

          // SUBMIT FORMULAR - Trimite comanda către server
          document.getElementById('checkout-form').addEventListener('submit', function(e){
            e.preventDefault();
            var btn = document.getElementById('place-order');
            btn.disabled = true;
            btn.textContent = 'Se procesează...';

            if(!window.productsAPI || !window.productsAPI.createOrder){ toast('API comenzi indisponibil'); btn.disabled = false; return; }
            
            window.productsAPI.createOrder({
              nume_client: document.getElementById('order-nume').value,
              email_client: u.email,
              telefon_client: document.getElementById('order-tel').value,
              adresa_livrare: document.getElementById('order-adresa').value,
              oras_livrare: document.getElementById('order-oras').value,
              cod_postal_livrare: document.getElementById('order-postal').value,
              tara_livrare: 'Romania',
              metoda_plata: document.getElementById('order-plata').value,
              note: 'Comandă plasată din procesul de checkout.'
            }).then(function(){
              toast('Comanda a fost trimisă cu succes!');
              // Redirecționare către istoricul de comenzi
              setTimeout(function(){ window.location.href = 'orders.html'; }, 1000);
            }).catch(function(err){ 
              toast(err.message || 'Eroare la plasarea comenzii'); 
              btn.disabled = false; 
              btn.textContent = 'Plasează Comanda';
            });
          });
        }).catch(function(err){ root.innerHTML = '<p style="color:red">Eroare la încărcarea coșului.</p>'; console.error(err); });
      });
    })();
  </script>
</body>
</html>
