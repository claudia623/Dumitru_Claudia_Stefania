<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coșul de cumpărături</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="site-layout">
    <header>
        <h1>Magazin de Plușuri Croșetate</h1>
    </header>
    <nav>
        <div class="nav-center">
            <a href="index.html">Acasă</a>
            <a href="produse.html">Produse</a>
            <a href="contact.html">Contact</a>
        </div>
        <div class="nav-right">
            <a href="cart.html" class="cart-icon" title="Coș de cumpărături">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="currentColor"><path d="M7 20a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm10 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4zM7.16 16h9.68c.8 0 1.5-.48 1.8-1.22l3.24-7.24A1 1 0 0 0 21 6H6.21l-.94-2.36A1 1 0 0 0 4.34 2H1v2h2.34l3.6 9.03-1.35 2.44C4.52 16.37 5.48 18 7 18h12v-2H7.42a.25.25 0 0 1-.22-.13l.96-1.87z"/></svg>
                <span class="cart-badge" id="cart-badge" style="display:none">0</span>
            </a>
            <a href="login.html" class="login-link">Login</a>
        </div>
    </nav>
    <script src="site-ui.js"></script>
    <main>
        <div class="cart-wrapper">
            <section class="cart-card" id="cart-content">
                <!-- Cart content will be rendered here by JS -->
                <h2 style="color:#b97a7a;text-align:center">Coșul tău de cumpărături</h2>
                <div id="cart-inner" style="margin-top:12px;">
                    <p class="cart-empty" style="color:#7d4c4c;text-align:center;padding:20px;">Se încarcă...</p>
                </div>
            </section>
        </div>
    </main>
    <script src="cart.js"></script>
    <script src="auth-api.js"></script>
    <script src="site-ui.js"></script>
    <script>
        
        function getCart(){
            if(window.cartAPI && window.cartAPI.getCart){ return window.cartAPI.getCart(); }
            return Promise.resolve([]);
        }
        function renderCart(){
            var container = document.getElementById('cart-inner');
            container.innerHTML = '';
            getCart().then(function(cart){
            cart = cart || [];
            if(!cart.length){
                container.innerHTML = '<p class="cart-empty" style="color:#7d4c4c;text-align:center;padding:20px;">Momentan coșul este gol.</p>';
                return;
            }
            var table = document.createElement('table'); table.className = 'cart-list';
            var thead = document.createElement('thead'); thead.innerHTML = '<tr><th>Produs</th><th>Cantitate</th><th>Preț</th><th>Total</th><th></th></tr>';
            table.appendChild(thead);
            var tbody = document.createElement('tbody');
            var total = 0;
            cart.forEach(function(it){
                var tr = document.createElement('tr');
                var titleTd = document.createElement('td');
                var title = it.title || it.nume_produs || '';
                var price = Number(it.price || it.pret_unitar || 0);
                var qty = Number(it.qty || it.cantitate || 1);
                var imageUrl = it.image || (it.imagine_id ? (window.productsAPI ? window.productsAPI.getProductImage(it.id_produs, it.imagine_id) : '') : '');
                titleTd.innerHTML = '<div style="display:flex;gap:8px;align-items:center"><img src="'+(imageUrl||'')+'" style="width:48px;height:48px;object-fit:cover;border-radius:6px"> <div><strong>'+ title +'</strong></div></div>';
                var qtyTd = document.createElement('td');
                // create qty control (numeric input only)
                var qtyInput = document.createElement('input'); qtyInput.type = 'number'; qtyInput.min = '1'; qtyInput.value = qty; qtyInput.className = 'qty-input'; qtyInput.setAttribute('aria-label','Cantitate'); qtyInput.dataset.id = String(it.id_cos || it.id);
                qtyTd.appendChild(qtyInput);

                var priceTd = document.createElement('td'); priceTd.textContent = price + ' lei';
                var lineTotal = price * qty; total += lineTotal;
                var totalTd = document.createElement('td'); totalTd.textContent = lineTotal + ' lei';
                var remTd = document.createElement('td'); remTd.innerHTML = '<button class="btn ghost remove-item" data-id="'+ String(it.id_cos || it.id) +'">Șterge</button>';
                tr.appendChild(titleTd); tr.appendChild(qtyTd); tr.appendChild(priceTd); tr.appendChild(totalTd); tr.appendChild(remTd);
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            var footer = document.createElement('div'); footer.style.marginTop='12px'; footer.innerHTML = '<div style="text-align:right;font-weight:700">Total: '+ total +' lei</div><div style="margin-top:8px;text-align:right"><button class="btn" id="checkout-btn">Finalizează comanda</button> <button class="btn ghost" id="clear-cart">Golește coș</button></div>';
            container.appendChild(table); container.appendChild(footer);
            // attach remove handlers with fade-out animation
            container.querySelectorAll('.remove-item').forEach(function(b){
                b.addEventListener('click', function(){
                    var id = b.dataset.id;
                    var row = b.closest('tr');
                    if(row){ row.classList.add('fade-out'); }
                    setTimeout(function(){
                        if(window.cartAPI && window.cartAPI.removeItem) window.cartAPI.removeItem(id);
                        else { var c=JSON.parse(localStorage.getItem('cart')||'[]'); c=c.filter(function(x){return String(x.id) !== String(id)}); localStorage.setItem('cart',JSON.stringify(c)); window.dispatchEvent(new CustomEvent('cartUpdated',{detail:{cart:c}})); }
                    }, 320);
                });
            });
            // (no +/- buttons) qty changes are handled by the numeric inputs below
            // attach input handlers for direct keyboard editing
            container.querySelectorAll('.qty-input').forEach(function(inp){
                inp.addEventListener('change', function(){
                    var id = inp.dataset.id;
                    var val = Number(inp.value) || 1;
                    if(val < 1) val = 1;
                    // reflect sanitized value back to input
                    inp.value = val;
                    if(window.cartAPI && window.cartAPI.updateQty){
                        window.cartAPI.updateQty(id, val);
                    } else {
                        var c = JSON.parse(localStorage.getItem('cart')||'[]');
                        var item = c.find(function(x){ return String(x.id) === String(id); });
                        if(!item) return;
                        item.qty = val;
                        localStorage.setItem('cart', JSON.stringify(c));
                        window.dispatchEvent(new CustomEvent('cartUpdated',{detail:{cart:c}}));
                    }
                });
                // optional: handle arrow keys and Enter
                inp.addEventListener('keydown', function(e){
                    if(e.key === 'ArrowUp'){ e.preventDefault(); inp.value = Number(inp.value || 0) + 1; inp.dispatchEvent(new Event('change')); }
                    if(e.key === 'ArrowDown'){ e.preventDefault(); inp.value = Math.max(1, Number(inp.value || 0) - 1); inp.dispatchEvent(new Event('change')); }
                    if(e.key === 'Enter'){ inp.dispatchEvent(new Event('change')); }
                });
            });
            var clearBtn = document.getElementById('clear-cart'); if(clearBtn) clearBtn.addEventListener('click', function(){ if(window.cartAPI && window.cartAPI.clearCart) window.cartAPI.clearCart(); else { localStorage.removeItem('cart'); window.dispatchEvent(new CustomEvent('cartUpdated',{detail:{cart:[]}})); } });
            }).catch(function(err){ container.innerHTML = '<p style="color:red;text-align:center">Eroare la încărcarea coșului.</p>'; console.error(err); });
        }
        document.addEventListener('DOMContentLoaded', function(){ renderCart(); window.addEventListener('cartUpdated', function(){ renderCart(); }); });
    </script>
    <aside>
        <div class="newsletter-box" style="padding:15px; background:rgba(212,99,122,0.05); border-radius:10px; margin-top:20px;">
            <h4 style="margin-top:0">Newsletter</h4>
            <p style="font-size:0.9rem">Abonează-te pentru a afla când adaug plușuri noi!</p>
            <input type="email" placeholder="email@exemplu.com" style="margin-bottom:8px">
            <button class="add-btn" style="width:100%">Abonează-te</button>
        </div>
    </aside>
    <footer class="site-footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-about">
                    <h4>Despre noi</h4>
                    <p>Plușuri croșetate manual, create cu grijă și atenție la detalii. Cadouri perfecte pentru toate vârstele.</p>
                </div>
                <div class="footer-contact">
                    <h4>Contact</h4>
                    <p>Email: <a href="mailto:plusuricrosetate@email.com">plusuricrosetate@email.com</a></p>
                    <p>Telefon: 0722 123 456</p>
                </div>
                <div class="footer-links">
                    <h4>Link-uri</h4>
                    <p><a href="produse.html">Produse</a></p>
                    <p><a href="contact.html">Formular contact</a></p>
                    <p><a href="cart.html">Coș</a></p>
                </div>
            </div>
            <div class="footer-bottom text-center muted">&copy; 2025 Magazin Plușuri Croșetate. Toate drepturile rezervate.</div>
        </div>
    </footer>
    <button id="back-to-top" onclick="window.scrollTo({top:0, behavior:'smooth'})" title="Înapoi sus">↑</button>
    <script defer src="auth-api.js"></script>
    <script defer src="site-ui.js"></script>
    <script defer src="products-api.js"></script>
</body>
</html>
