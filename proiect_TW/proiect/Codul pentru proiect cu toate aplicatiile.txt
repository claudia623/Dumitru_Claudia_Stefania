

-- TABEL: utilizatori
CREATE TABLE utilizatori (
  id_utilizator INT PRIMARY KEY AUTO_INCREMENT,
  nume_utilizator VARCHAR(100) NOT NULL,
  email VARCHAR(100) UNIQUE NOT NULL,
  username VARCHAR(50) UNIQUE NOT NULL,
  parola VARCHAR(255) NOT NULL,
  rol ENUM('client', 'admin') NOT NULL,
  data_inregistrare DATE NOT NULL DEFAULT CURRENT_DATE
);

CREATE TABLE categorii (
  id_categorie INT PRIMARY KEY AUTO_INCREMENT,
  nume_categorie VARCHAR(50) UNIQUE NOT NULL
);


-- TABEL: produse
CREATE TABLE produse (
  id_produs INT PRIMARY KEY AUTO_INCREMENT,
  nume_produs VARCHAR(100) NOT NULL,
  descriere TEXT,
  pret DECIMAL(10,2) NOT NULL,
  stoc INT NOT NULL DEFAULT 0,
  id_categorie INT,
  imagine VARCHAR(255),
  data_adaugare DATE NOT NULL DEFAULT CURRENT_DATE,
  FOREIGN KEY (id_categorie) REFERENCES categorii(id_categorie)
);


-- TABEL: comenzi
CREATE TABLE comenzi (
  id_comanda INT PRIMARY KEY AUTO_INCREMENT,
  id_utilizator INT NOT NULL,
  data_comanda DATE NOT NULL DEFAULT CURRENT_DATE,
  status ENUM('in procesare', 'livrata', 'anulata') DEFAULT 'in procesare',
  total DECIMAL(10,2),
  FOREIGN KEY (id_utilizator) REFERENCES utilizatori(id_utilizator)
);

-- TABEL: detalii_comanda (many-to-many între comenzi și produse)
CREATE TABLE detalii_comanda (
  id_detaliu INT PRIMARY KEY AUTO_INCREMENT,
  id_comanda INT NOT NULL,
  id_produs INT NOT NULL,
  cantitate INT NOT NULL,
  pret_unitar DECIMAL(10,2) NOT NULL,
  FOREIGN KEY (id_comanda) REFERENCES comenzi(id_comanda),
  FOREIGN KEY (id_produs) REFERENCES produse(id_produs)
);

-- TABEL: recenzii
CREATE TABLE recenzii (
  id_recenzie INT PRIMARY KEY AUTO_INCREMENT,
  id_utilizator INT NOT NULL,
  id_produs INT NOT NULL,
  comentariu TEXT,
  rating INT CHECK (rating BETWEEN 1 AND 5),
  data DATE NOT NULL DEFAULT CURRENT_DATE,
  FOREIGN KEY (id_utilizator) REFERENCES utilizatori(id_utilizator),
  FOREIGN KEY (id_produs) REFERENCES produse(id_produs)
);

-- TABEL: cos_cumparaturi
CREATE TABLE cos_cumparaturi (
  id_cos INT PRIMARY KEY AUTO_INCREMENT,
  id_utilizator INT NOT NULL,
  id_produs INT NOT NULL,
  cantitate INT NOT NULL DEFAULT 1,
  data_adaugare DATE NOT NULL DEFAULT CURRENT_DATE,
  FOREIGN KEY (id_utilizator) REFERENCES utilizatori(id_utilizator),
  FOREIGN KEY (id_produs) REFERENCES produse(id_produs)
);

show tables

-- Populare tabel: categorii
INSERT INTO categorii (nume_categorie) VALUES
('Animale'),
('Personaje'),
('Sezoniere'),
('Pentru copii'),
('Tematice');

-- Populare tabel: utilizatori
DELIMITER $$

CREATE PROCEDURE populeaza_utilizatori()
BEGIN
  DECLARE i INT DEFAULT 1;
  WHILE i <= 50 DO
    INSERT INTO utilizatori (nume_utilizator, email, username, parola, rol)
    VALUES (
      CONCAT('Utilizator', i),
      CONCAT('user', i, '@exemplu.com'),
      CONCAT('user', i),
      SHA2(CONCAT('parola', i), 256),
      'client'
    );
    SET i = i + 1;
  END WHILE;
END $$

DELIMITER ;

CALL populeaza_utilizatori();

-- Populare tabel: produse
DELIMITER $$

CREATE PROCEDURE populeaza_produse()
BEGIN
  DECLARE i INT DEFAULT 1;
  WHILE i <= 50 DO
    INSERT INTO produse (nume_produs, descriere, pret, stoc, id_categorie, imagine)
    VALUES (
      CONCAT('Plus Crosetat ', i),
      CONCAT('Descriere produs crosetat nr. ', i),
      ROUND(RAND() * 100 + 20, 2),
      FLOOR(RAND() * 20 + 1),
      FLOOR(RAND() * 5 + 1),
      CONCAT('imagine', i, '.jpg')
    );
    SET i = i + 1;
  END WHILE;
END $$

DELIMITER ;

CALL populeaza_produse();

-- Populare tabel: comenzi
DELIMITER $$

CREATE PROCEDURE populeaza_comenzi()
BEGIN
  DECLARE i INT DEFAULT 1;
  WHILE i <= 50 DO
    INSERT INTO comenzi (id_utilizator, status, total)
    VALUES (
      FLOOR(RAND() * 50 + 1),
      ELT(FLOOR(RAND() * 3 + 1), 'in procesare', 'livrata', 'anulata'),
      ROUND(RAND() * 300 + 50, 2)
    );
    SET i = i + 1;
  END WHILE;
END $$

DELIMITER ;

CALL populeaza_comenzi();

-- Populare tabel: detalii_comanda
DELIMITER $$

CREATE PROCEDURE populeaza_detalii_comanda()
BEGIN
  DECLARE i INT DEFAULT 1;
  WHILE i <= 50 DO
    INSERT INTO detalii_comanda (id_comanda, id_produs, cantitate, pret_unitar)
    VALUES (
      FLOOR(RAND() * 50 + 1),
      FLOOR(RAND() * 50 + 1),
      FLOOR(RAND() * 5 + 1),
      ROUND(RAND() * 100 + 20, 2)
    );
    SET i = i + 1;
  END WHILE;
END $$

DELIMITER ;

CALL populeaza_detalii_comanda();

-- Populare tabel: recenzii
DELIMITER $$

CREATE PROCEDURE populeaza_recenzii()
BEGIN
  DECLARE i INT DEFAULT 1;
  WHILE i <= 50 DO
    INSERT INTO recenzii (id_utilizator, id_produs, comentariu, rating)
    VALUES (
      FLOOR(RAND() * 50 + 1),
      FLOOR(RAND() * 50 + 1),
      CONCAT('Foarte drăguț produsul ', i),
      FLOOR(RAND() * 5 + 1)
    );
    SET i = i + 1;
  END WHILE;
END $$

DELIMITER ;

CALL populeaza_recenzii();

-- Populare tabel: cos_cumparaturi
DELIMITER $$

CREATE PROCEDURE populeaza_cos()
BEGIN
  DECLARE i INT DEFAULT 1;
  WHILE i <= 50 DO
    INSERT INTO cos_cumparaturi (id_utilizator, id_produs, cantitate)
    VALUES (
      FLOOR(RAND() * 50 + 1),
      FLOOR(RAND() * 50 + 1),
      FLOOR(RAND() * 3 + 1)
    );
    SET i = i + 1;
  END WHILE;
END $$

DELIMITER ;

CALL populeaza_cos();


SELECT c.id_comanda, u.username, c.status, c.total
FROM comenzi c
JOIN utilizatori u ON c.id_utilizator = u.id_utilizator;

SELECT nume_produs, pret
FROM produse
WHERE pret BETWEEN 30 AND 80
ORDER BY pret DESC;

SELECT id_utilizator, username, email
FROM utilizatori
WHERE username LIKE '%user1%';

SELECT status, COUNT(*) AS numar_comenzi
FROM comenzi
GROUP BY status;

SELECT SUM(total) AS total_incasari
FROM comenzi;

SELECT p.nume_produs, AVG(r.rating) AS rating_mediu
FROM produse p
JOIN recenzii r ON p.id_produs = r.id_produs
GROUP BY p.nume_produs
ORDER BY rating_mediu DESC;

SELECT DISTINCT u.username, c.total
FROM utilizatori u
JOIN comenzi c ON u.id_utilizator = c.id_utilizator
WHERE c.total > 200;

SELECT p.nume_produs, COUNT(dc.id_produs) AS nr_vanzari
FROM produse p
JOIN detalii_comanda dc ON p.id_produs = dc.id_produs
GROUP BY p.nume_produs
ORDER BY nr_vanzari DESC;

SELECT c.id_comanda, u.username, p.nume_produs
FROM comenzi c
JOIN detalii_comanda dc ON c.id_comanda = dc.id_comanda
JOIN produse p ON dc.id_produs = p.id_produs
JOIN utilizatori u ON c.id_utilizator = u.id_utilizator
WHERE p.nume_produs = 'Plus Crosetat 7';

SELECT p.nume_produs, p.pret, c.nume_categorie
FROM produse p
JOIN categorii c ON p.id_categorie = c.id_categorie
WHERE c.nume_categorie = 'Animale';

-- 1. Creare utilizator administrator
CREATE USER 'admin_perm'@'%' IDENTIFIED BY 'admin123';
GRANT ALL PRIVILEGES ON Dumitru_Claudia_Stefania.* TO 'admin_perm'@'%' WITH GRANT OPTION;

-- 2. Utilizator pentru gestionare produse (citire + inserare)
CREATE USER 'prod_user'@'%' IDENTIFIED BY 'prod123';
GRANT SELECT, INSERT ON Dumitru_Claudia_Stefania.produse TO 'prod_user'@'%';

-- 3. Utilizator pentru comenzile clienților (modificare și inserare comenzi)
CREATE USER 'order_user'@'%' IDENTIFIED BY 'order123';
GRANT SELECT, INSERT, UPDATE ON Dumitru_Claudia_Stefania.comenzi TO 'order_user'@'%';

-- 4. Utilizator pentru analiză statistici (doar citire)
CREATE USER 'analytics_user'@'%' IDENTIFIED BY 'stat123';
GRANT SELECT ON Dumitru_Claudia_Stefania.* TO 'analytics_user'@'%';

-- 5. Utilizator pentru recenzii (poate insera și modifica recenzii)
CREATE USER 'review_user'@'%' IDENTIFIED BY 'review123';
GRANT SELECT, INSERT, UPDATE ON Dumitru_Claudia_Stefania.recenzii TO 'review_user'@'%';

# afisarea utilizatorilor
SELECT
    GRANTEE,
    TABLE_SCHEMA,
    TABLE_NAME,
    PRIVILEGE_TYPE
FROM
    information_schema.table_privileges
ORDER BY
    GRANTEE, TABLE_SCHEMA, TABLE_NAME;


#Creăm un index pe coloana 'id_produs' din tabelul 'recenzii' pentru a optimiza
#operația JOIN dintre tabelele 'produse' și 'recenzii'. Astfel, interogarea
# care calculează ratingul mediu pe produs va rula mai rapid, deoarece MySQL
# poate găsi mai rapid toate recenziile aferente fiecărui produs.

CREATE INDEX idx_recenzii_id_produs ON recenzii(id_produs);

SELECT p.nume_produs, AVG(r.rating) AS rating_mediu
FROM produse p
JOIN recenzii r ON p.id_produs = r.id_produs
GROUP BY p.nume_produs
ORDER BY rating_mediu DESC;

DELIMITER $$

CREATE PROCEDURE afiseaza_comenzi_utilizator(IN user_nume VARCHAR(50))
BEGIN
  SELECT c.id_comanda, c.data_comanda, c.status, c.total
  FROM comenzi c
  JOIN utilizatori u ON c.id_utilizator = u.id_utilizator
  WHERE u.username = user_nume
  ORDER BY c.data_comanda DESC;
END $$

DELIMITER ;

CALL afiseaza_comenzi_utilizator('user10');


CREATE PROCEDURE actualizeaza_stoc_produs(
  IN p_id_produs INT,
  IN p_cantitate INT
)
BEGIN
  UPDATE produse
  SET stoc = stoc + p_cantitate
  WHERE id_produs = p_id_produs;
END;


SELECT id_produs, nume_produs, stoc
FROM produse
WHERE id_produs = 5;

CALL actualizeaza_stoc_produs(5, 10);

SELECT id_produs, nume_produs, stoc
FROM produse
WHERE id_produs = 5;

CREATE TABLE date_sensibile (
  id INT PRIMARY KEY AUTO_INCREMENT,
  id_utilizator INT NOT NULL,
  info_criptata VARBINARY(255) NOT NULL,
  FOREIGN KEY (id_utilizator) REFERENCES utilizatori(id_utilizator)
);

INSERT INTO date_sensibile (id_utilizator, info_criptata)
VALUES (
  1, -- id utilizator exemplu
  AES_ENCRYPT('Acesta este un text secret', 'cheia_secretă')
);

SELECT
  id_utilizator,
  CAST(AES_DECRYPT(info_criptata, 'cheia_secretă') AS CHAR) AS info_decriptata
FROM date_sensibile;
